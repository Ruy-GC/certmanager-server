env:
  DB_HOST: ${{secrets.AZURE_HOST}}
  DB_DATABASE: test
  DB_USER: ${{secrets.AZURE_UN}}
  DB_PASSWORD: ${{secrets.AZURE_PW}}

name: "Rspec tests"
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
    test:
        runs-on: ubuntu-latest
        name: Run Rspec Tests
        services:
          mysql:
            image: mysql:8.0
            env:
              MYSQL_HOST: ${{env.DB_HOST}}
              MYSQL_USER: ${{env.DB_USER}}
              MYSQL_PASSWORD: ${{env.DB_PASSWORD}}
              MYSQL_DATABASE: ${{env.DB_DATABASE}}
              MYSQL_ROOT_PASSWORD:  ${{env.DB_PASSWORD}}
            ports:
              - "3306:3306"
        env:
          RAILS_ENV: test

        steps:
            - name: "Checkout repository"
              uses: actions/checkout@v1

            - name: "Setup ruby"
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: '3.2.2'
                bundler-cache: true

            - name: "Start MySQL service"
              run: |
                sudo service mysql start
                mysql -h ${{env.DB_HOST}} -u ${{env.DB_USER}} -p
                ${{env.DB_PASSWORD}}
                
            - name: "Authentication spec"
              run: bundle exec rspec ./spec/requests/authentication_spec.rb
